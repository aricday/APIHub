{"ast":null,"code":"import _toConsumableArray from\"/Users/aricday/Projects/APIHub/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"/Users/aricday/Projects/APIHub/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _objectWithoutProperties from\"/Users/aricday/Projects/APIHub/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";import _objectSpread from\"/Users/aricday/Projects/APIHub/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import React,{useState,useMemo}from'react';import Button from'@material-ui/core/Button';import Dialog from'@material-ui/core/Dialog';import DialogActions from'@material-ui/core/DialogActions';import DialogContent from'@material-ui/core/DialogContent';import DialogTitle from'@material-ui/core/DialogTitle';import Select from'@material-ui/core/Select';import FormControl from'@material-ui/core/FormControl';import InputLabel from'@material-ui/core/InputLabel';import MenuItem from'@material-ui/core/MenuItem';import{makeStyles}from'@material-ui/core/styles';import IconAccountTree from'@material-ui/icons/AccountTree';import{useMutation,useNotify,useTranslate,CRUD_GET_LIST_SUCCESS,GET_LIST,FETCH_END}from'ra-core';import flow from'lodash/flow';import{useDispatch}from'react-redux';import{DocumentationTree,getChildDocuments,sortByOrdinal}from'./DocumentationTree';import{getAllDocumentParents}from'./getAllDocumentParents';var useStyles=makeStyles({fullWidth:{width:'100%'}});export var FakeRootUuid='@layer7-fake-root';export var moveDocument=function moveDocument(_ref){var document=_ref.document,newParentId=_ref.newParentId,ordinal=_ref.ordinal,allDocuments=_ref.allDocuments;var newDocuments=Array.from(allDocuments);var updatedDocument=newDocuments.find(function(doc){return doc.id===document.id;});if(!updatedDocument||!newParentId){return;}var newParent=newDocuments.find(function(doc){return doc.id===newParentId;});if(!newParent){return;}var newSiblingsWhichMustBeMoved=newDocuments.filter(function(doc){return doc.parentUuid===newParent.uuid&&doc.ordinal>=ordinal;});newSiblingsWhichMustBeMoved.forEach(function(doc,index){doc.ordinal+=1;});var oldSiblingsWhichMustBeMoved=newDocuments.filter(function(doc){return doc.parentUuid===updatedDocument.parentUuid&&doc.ordinal>updatedDocument.ordinal;});oldSiblingsWhichMustBeMoved.forEach(function(doc,index){doc.ordinal-=1;});newDocuments.filter(function(item){return item.parentUuid===FakeRootUuid;});updatedDocument.parentUuid=newParent.uuid;updatedDocument.ordinal=ordinal;return newDocuments;};var cleanupFakeRootUuid=function cleanupFakeRootUuid(items){return items.filter(function(item){return item.id!==FakeRootUuid;}).reduce(function(acc,item){if(item.parentUuid===FakeRootUuid){acc.push(_objectSpread({},item,{parentUuid:undefined}));return acc;}acc.push(item);return acc;},[]);};var prepareDataForUpdate=function prepareDataForUpdate(items){return items.map(function(_ref2){var id=_ref2.id,children=_ref2.children,markdown=_ref2.markdown,item=_objectWithoutProperties(_ref2,[\"id\",\"children\",\"markdown\"]);return item;});};export var ChangeParentDocumentButton=function ChangeParentDocumentButton(_ref3){var _ref3$allDocuments=_ref3.allDocuments,allDocuments=_ref3$allDocuments===void 0?[]:_ref3$allDocuments,document=_ref3.document,entityType=_ref3.entityType,entityUuid=_ref3.entityUuid,locale=_ref3.locale,props=_objectWithoutProperties(_ref3,[\"allDocuments\",\"document\",\"entityType\",\"entityUuid\",\"locale\"]);var _useState=useState(false),_useState2=_slicedToArray(_useState,2),open=_useState2[0],setOpen=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),newSibling=_useState4[0],setNewSiblings=_useState4[1];var _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),newParentId=_useState6[0],setNewParentId=_useState6[1];var _useState7=useState(0),_useState8=_slicedToArray(_useState7,2),ordinal=_useState8[0],setOrdinal=_useState8[1];var classes=useStyles();var translate=useTranslate();var dispatch=useDispatch();var notify=useNotify();// Here we introduce a fake root item so that users have something\n// to select in order to move a document to the root\nvar treeItems=useMemo(function(){return[{id:FakeRootUuid,uuid:FakeRootUuid,title:translate('resources.documents.actions.move_as_root_item')}].concat(_toConsumableArray(allDocuments.map(function(doc){return!!doc.parentUuid?doc:_objectSpread({},doc,{parentUuid:FakeRootUuid});})));},[allDocuments,translate]);var currentDocumentParents=getAllDocumentParents(document,allDocuments);var _useState9=useState([FakeRootUuid].concat(_toConsumableArray(currentDocumentParents.map(function(parent){return parent.id;})))),_useState10=_slicedToArray(_useState9,2),expanded=_useState10[0],setExpanded=_useState10[1];var _useMutation=useMutation({type:'updateTree',resource:'documents'}),_useMutation2=_slicedToArray(_useMutation,2),mutate=_useMutation2[0],loading=_useMutation2[1].loading;var handleClick=function handleClick(){setOpen(true);};var handleClose=function handleClose(){setOpen(false);};var handleSave=function handleSave(){var newDocuments=flow([moveDocument,cleanupFakeRootUuid])({document:document,newParentId:newParentId,ordinal:ordinal,allDocuments:treeItems});mutate({payload:{entityType:entityType,entityUuid:entityUuid,locale:locale,data:prepareDataForUpdate(newDocuments)}},{undoable:true,onSuccess:function onSuccess(){setOpen(false);// Fake a getList fetch success to optimistically update\n// the treeview, avoiding a full view refresh\ndispatch({type:CRUD_GET_LIST_SUCCESS,payload:{data:newDocuments,total:newDocuments.length},meta:{resource:'documents',fetchResponse:GET_LIST,fetchStatus:FETCH_END}});notify('resources.documents.notifications.tree_updated_success','info',undefined,true);},onFailure:function onFailure(){notify('resources.documents.notifications.tree_updated_error','warning');// Fake a getList fetch success to optimistically update\n// the treeview, avoiding a full view refresh\n// Here we pass the original documents\ndispatch({type:CRUD_GET_LIST_SUCCESS,payload:{data:allDocuments,total:allDocuments.length},meta:{resource:'documents',fetchResponse:GET_LIST,fetchStatus:FETCH_END}});}});};var handleNewParentSelected=function handleNewParentSelected(node){setNewParentId(node.id);var newParent=treeItems.find(function(doc){return doc.id===node.id;});if(!newParent){setOrdinal(0);setNewSiblings([]);return;}var siblings=getChildDocuments(newParent,treeItems,sortByOrdinal);if(siblings.length===0){setOrdinal(0);setNewSiblings([]);return;}setNewSiblings(siblings);};var handleOrdinalChange=function handleOrdinalChange(event){return setOrdinal(event.target.value);};return React.createElement(React.Fragment,null,React.createElement(Button,Object.assign({onClick:handleClick,\"aria-label\":translate('resources.documents.actions.change_document_parent_button'),startIcon:React.createElement(IconAccountTree,null)},props),translate('resources.documents.actions.change_document_parent_button')),React.createElement(Dialog,{open:open,onClose:handleClose,\"aria-labelledby\":\"form-dialog-title\"},React.createElement(DialogTitle,{id:\"form-dialog-title\"},translate('resources.documents.actions.change_document_parent_button')),React.createElement(DialogContent,null,React.createElement(DocumentationTree,{items:treeItems.filter(function(item){return item.id!==document.id;}),selectedDocumentId:newParentId,onDocumentSelected:handleNewParentSelected,expanded:expanded,onExpandedChange:setExpanded}),React.createElement(\"hr\",null),newSibling.length>0?React.createElement(FormControl,{className:classes.fullWidth},React.createElement(InputLabel,{id:\"ordinal-select-label\"},translate('resources.documents.fields.ordinal')),React.createElement(Select,{labelId:\"ordinal-select-label\",key:newParentId,onChange:handleOrdinalChange,value:ordinal,className:classes.fullWidth},React.createElement(MenuItem,{value:0},translate('resources.documents.actions.move_as_first_child')),newSibling.map(function(child){return React.createElement(MenuItem,{key:child.id,value:child.ordinal+1},translate('resources.documents.actions.move_after_document',{title:child.title}));}))):null),React.createElement(DialogActions,null,React.createElement(Button,{onClick:handleClose,disabled:loading||!newParentId,color:\"primary\"},translate('ra.action.cancel')),React.createElement(Button,{onClick:handleSave,disabled:loading,color:\"primary\"},translate('ra.action.save')))));};ChangeParentDocumentButton.__docgenInfo={\"description\":\"\",\"methods\":[],\"displayName\":\"ChangeParentDocumentButton\",\"props\":{\"allDocuments\":{\"defaultValue\":{\"value\":\"[]\",\"computed\":false},\"required\":false}}};if(typeof STORYBOOK_REACT_CLASSES!==\"undefined\"){STORYBOOK_REACT_CLASSES[\"src/apis/Documentation/ChangeParentDocumentButton.js\"]={name:\"ChangeParentDocumentButton\",docgenInfo:ChangeParentDocumentButton.__docgenInfo,path:\"src/apis/Documentation/ChangeParentDocumentButton.js\"};}","map":{"version":3,"sources":["/Users/aricday/Projects/APIHub/packages/layer7-apihub/src/apis/Documentation/ChangeParentDocumentButton.js"],"names":["React","useState","useMemo","Button","Dialog","DialogActions","DialogContent","DialogTitle","Select","FormControl","InputLabel","MenuItem","makeStyles","IconAccountTree","useMutation","useNotify","useTranslate","CRUD_GET_LIST_SUCCESS","GET_LIST","FETCH_END","flow","useDispatch","DocumentationTree","getChildDocuments","sortByOrdinal","getAllDocumentParents","useStyles","fullWidth","width","FakeRootUuid","moveDocument","document","newParentId","ordinal","allDocuments","newDocuments","Array","from","updatedDocument","find","doc","id","newParent","newSiblingsWhichMustBeMoved","filter","parentUuid","uuid","forEach","index","oldSiblingsWhichMustBeMoved","item","cleanupFakeRootUuid","items","reduce","acc","push","undefined","prepareDataForUpdate","map","children","markdown","ChangeParentDocumentButton","entityType","entityUuid","locale","props","open","setOpen","newSibling","setNewSiblings","setNewParentId","setOrdinal","classes","translate","dispatch","notify","treeItems","title","currentDocumentParents","parent","expanded","setExpanded","type","resource","mutate","loading","handleClick","handleClose","handleSave","payload","data","undoable","onSuccess","total","length","meta","fetchResponse","fetchStatus","onFailure","handleNewParentSelected","node","siblings","handleOrdinalChange","event","target","value","child"],"mappings":"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","sourcesContent":["import React, { useState, useMemo } from 'react';\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogTitle from '@material-ui/core/DialogTitle';\nimport Select from '@material-ui/core/Select';\nimport FormControl from '@material-ui/core/FormControl';\nimport InputLabel from '@material-ui/core/InputLabel';\nimport MenuItem from '@material-ui/core/MenuItem';\nimport { makeStyles } from '@material-ui/core/styles';\nimport IconAccountTree from '@material-ui/icons/AccountTree';\nimport {\n    useMutation,\n    useNotify,\n    useTranslate,\n    CRUD_GET_LIST_SUCCESS,\n    GET_LIST,\n    FETCH_END,\n} from 'ra-core';\nimport flow from 'lodash/flow';\nimport { useDispatch } from 'react-redux';\n\nimport {\n    DocumentationTree,\n    getChildDocuments,\n    sortByOrdinal,\n} from './DocumentationTree';\nimport { getAllDocumentParents } from './getAllDocumentParents';\n\nconst useStyles = makeStyles({\n    fullWidth: {\n        width: '100%',\n    },\n});\n\nexport const FakeRootUuid = '@layer7-fake-root';\n\nexport const moveDocument = ({\n    document,\n    newParentId,\n    ordinal,\n    allDocuments,\n}) => {\n    const newDocuments = Array.from(allDocuments);\n\n    const updatedDocument = newDocuments.find(doc => doc.id === document.id);\n\n    if (!updatedDocument || !newParentId) {\n        return;\n    }\n\n    const newParent = newDocuments.find(doc => doc.id === newParentId);\n\n    if (!newParent) {\n        return;\n    }\n\n    const newSiblingsWhichMustBeMoved = newDocuments.filter(\n        doc => doc.parentUuid === newParent.uuid && doc.ordinal >= ordinal\n    );\n\n    newSiblingsWhichMustBeMoved.forEach((doc, index) => {\n        doc.ordinal += 1;\n    });\n\n    const oldSiblingsWhichMustBeMoved = newDocuments.filter(\n        doc =>\n            doc.parentUuid === updatedDocument.parentUuid &&\n            doc.ordinal > updatedDocument.ordinal\n    );\n\n    oldSiblingsWhichMustBeMoved.forEach((doc, index) => {\n        doc.ordinal -= 1;\n    });\n\n    newDocuments.filter(item => item.parentUuid === FakeRootUuid);\n\n    updatedDocument.parentUuid = newParent.uuid;\n    updatedDocument.ordinal = ordinal;\n\n    return newDocuments;\n};\n\nconst cleanupFakeRootUuid = items =>\n    items\n        .filter(item => item.id !== FakeRootUuid)\n        .reduce((acc, item) => {\n            if (item.parentUuid === FakeRootUuid) {\n                acc.push({\n                    ...item,\n                    parentUuid: undefined,\n                });\n                return acc;\n            }\n            acc.push(item);\n            return acc;\n        }, []);\n\nconst prepareDataForUpdate = items =>\n    items.map(({ id, children, markdown, ...item }) => item);\n\nexport const ChangeParentDocumentButton = ({\n    allDocuments = [],\n    document,\n    entityType,\n    entityUuid,\n    locale,\n    ...props\n}) => {\n    const [open, setOpen] = useState(false);\n    const [newSibling, setNewSiblings] = useState([]);\n    const [newParentId, setNewParentId] = useState(null);\n    const [ordinal, setOrdinal] = useState(0);\n    const classes = useStyles();\n\n    const translate = useTranslate();\n    const dispatch = useDispatch();\n    const notify = useNotify();\n\n    // Here we introduce a fake root item so that users have something\n    // to select in order to move a document to the root\n    const treeItems = useMemo(\n        () => [\n            {\n                id: FakeRootUuid,\n                uuid: FakeRootUuid,\n                title: translate(\n                    'resources.documents.actions.move_as_root_item'\n                ),\n            },\n            ...allDocuments.map(doc =>\n                !!doc.parentUuid\n                    ? doc\n                    : {\n                          ...doc,\n                          parentUuid: FakeRootUuid,\n                      }\n            ),\n        ],\n        [allDocuments, translate]\n    );\n\n    const currentDocumentParents = getAllDocumentParents(\n        document,\n        allDocuments\n    );\n\n    const [expanded, setExpanded] = useState([\n        FakeRootUuid,\n        ...currentDocumentParents.map(parent => parent.id),\n    ]);\n\n    const [mutate, { loading }] = useMutation({\n        type: 'updateTree',\n        resource: 'documents',\n    });\n\n    const handleClick = () => {\n        setOpen(true);\n    };\n\n    const handleClose = () => {\n        setOpen(false);\n    };\n\n    const handleSave = () => {\n        const newDocuments = flow([moveDocument, cleanupFakeRootUuid])({\n            document,\n            newParentId,\n            ordinal,\n            allDocuments: treeItems,\n        });\n\n        mutate(\n            {\n                payload: {\n                    entityType,\n                    entityUuid,\n                    locale,\n                    data: prepareDataForUpdate(newDocuments),\n                },\n            },\n            {\n                undoable: true,\n                onSuccess: () => {\n                    setOpen(false);\n\n                    // Fake a getList fetch success to optimistically update\n                    // the treeview, avoiding a full view refresh\n                    dispatch({\n                        type: CRUD_GET_LIST_SUCCESS,\n                        payload: {\n                            data: newDocuments,\n                            total: newDocuments.length,\n                        },\n                        meta: {\n                            resource: 'documents',\n                            fetchResponse: GET_LIST,\n                            fetchStatus: FETCH_END,\n                        },\n                    });\n                    notify(\n                        'resources.documents.notifications.tree_updated_success',\n                        'info',\n                        undefined,\n                        true\n                    );\n                },\n                onFailure: () => {\n                    notify(\n                        'resources.documents.notifications.tree_updated_error',\n                        'warning'\n                    );\n                    // Fake a getList fetch success to optimistically update\n                    // the treeview, avoiding a full view refresh\n                    // Here we pass the original documents\n                    dispatch({\n                        type: CRUD_GET_LIST_SUCCESS,\n                        payload: {\n                            data: allDocuments,\n                            total: allDocuments.length,\n                        },\n                        meta: {\n                            resource: 'documents',\n                            fetchResponse: GET_LIST,\n                            fetchStatus: FETCH_END,\n                        },\n                    });\n                },\n            }\n        );\n    };\n\n    const handleNewParentSelected = node => {\n        setNewParentId(node.id);\n\n        const newParent = treeItems.find(doc => doc.id === node.id);\n        if (!newParent) {\n            setOrdinal(0);\n            setNewSiblings([]);\n            return;\n        }\n        const siblings = getChildDocuments(newParent, treeItems, sortByOrdinal);\n\n        if (siblings.length === 0) {\n            setOrdinal(0);\n            setNewSiblings([]);\n            return;\n        }\n\n        setNewSiblings(siblings);\n    };\n\n    const handleOrdinalChange = event => setOrdinal(event.target.value);\n\n    return (\n        <>\n            <Button\n                onClick={handleClick}\n                aria-label={translate(\n                    'resources.documents.actions.change_document_parent_button'\n                )}\n                startIcon={<IconAccountTree />}\n                {...props}\n            >\n                {translate(\n                    'resources.documents.actions.change_document_parent_button'\n                )}\n            </Button>\n            <Dialog\n                open={open}\n                onClose={handleClose}\n                aria-labelledby=\"form-dialog-title\"\n            >\n                <DialogTitle id=\"form-dialog-title\">\n                    {translate(\n                        'resources.documents.actions.change_document_parent_button'\n                    )}\n                </DialogTitle>\n                <DialogContent>\n                    <DocumentationTree\n                        items={treeItems.filter(\n                            item => item.id !== document.id\n                        )}\n                        selectedDocumentId={newParentId}\n                        onDocumentSelected={handleNewParentSelected}\n                        expanded={expanded}\n                        onExpandedChange={setExpanded}\n                    />\n                    <hr />\n                    {newSibling.length > 0 ? (\n                        <FormControl className={classes.fullWidth}>\n                            <InputLabel id=\"ordinal-select-label\">\n                                {translate(\n                                    'resources.documents.fields.ordinal'\n                                )}\n                            </InputLabel>\n                            <Select\n                                labelId=\"ordinal-select-label\"\n                                key={newParentId}\n                                onChange={handleOrdinalChange}\n                                value={ordinal}\n                                className={classes.fullWidth}\n                            >\n                                <MenuItem value={0}>\n                                    {translate(\n                                        'resources.documents.actions.move_as_first_child'\n                                    )}\n                                </MenuItem>\n                                {newSibling.map(child => (\n                                    <MenuItem\n                                        key={child.id}\n                                        value={child.ordinal + 1}\n                                    >\n                                        {translate(\n                                            'resources.documents.actions.move_after_document',\n                                            { title: child.title }\n                                        )}\n                                    </MenuItem>\n                                ))}\n                            </Select>\n                        </FormControl>\n                    ) : null}\n                </DialogContent>\n                <DialogActions>\n                    <Button\n                        onClick={handleClose}\n                        disabled={loading || !newParentId}\n                        color=\"primary\"\n                    >\n                        {translate('ra.action.cancel')}\n                    </Button>\n                    <Button\n                        onClick={handleSave}\n                        disabled={loading}\n                        color=\"primary\"\n                    >\n                        {translate('ra.action.save')}\n                    </Button>\n                </DialogActions>\n            </Dialog>\n        </>\n    );\n};\n"]},"metadata":{},"sourceType":"module"}